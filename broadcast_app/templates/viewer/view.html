<!DOCTYPE html>
<html>
<head>
  <title>Live Viewer â€“ {{ title }}</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; text-align: center; padding: 30px; }
    img { width: 640px; height: 480px; border: 2px solid #333; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    .stats-overlay { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 8px; z-index: 1000; }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <h2>Now Streaming: {{ title }}</h2>
  <h3>By: {{ broadcaster }}</h3>
  <h4>Room ID: {{ roomId }}</h4>
  
  <div class="stats-overlay">
    <h4>Live Statistics</h4>
    <p>ðŸª‘ Empty Seats: <span id="stat-empty">0</span></p>
    <p>ðŸ‘¥ People: <span id="stat-people">0</span></p>
  </div>

  <img id="stream" alt="Live stream will appear here..." />
  <div id="offline-msg" style="display: none; color: red; font-size: 1.2em; margin-top: 10px;">
    ðŸ”´ Stream is currently offline.
  </div>

  <!-- Leave Room Button -->
  <button id="leaveBtn">Leave Room</button>

  <script>
    const roomId = "{{ roomId }}";
    const role   = "viewer";
    const socket = new WebSocket(
      `${location.protocol === "https:" ? "wss" : "ws"}://${window.location.host}`
      + `/ws/broadcast/${roomId}/?role=${role}`
    );

    const img        = document.getElementById("stream");
    const emptyEl    = document.getElementById("stat-empty");
    const peopleEl   = document.getElementById("stat-people");
    const offlineMsg = document.getElementById("offline-msg");
    const leaveBtn   = document.getElementById("leaveBtn");

    let offlineTimeout = setTimeout(() => {
      offlineMsg.style.display = "block";
    }, 5000);

    function leaveRoom() {
      if (socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
      window.location.href = '/viewer/dashboard';
    }

    socket.onmessage = e => {
      const msg = JSON.parse(e.data);
      const now = Date.now();
      const { ts_send, ts_server, frame, empty, persons } = msg;

      console.log(
        `RTT total=${now - ts_send}ms; `,
        `clientâ†’server=${ts_server - ts_send}ms; `,
        `serverâ†’client=${now - ts_server}ms`
      );

      img.src         = frame;
      emptyEl.textContent  = empty;
      peopleEl.textContent = persons;
      offlineMsg.style.display = "none";
      clearTimeout(offlineTimeout);
      offlineTimeout = setTimeout(() => offlineMsg.style.display = "block", 5000);
    };

    socket.onerror = err => console.error("WebSocket error:", err);
    socket.onclose = () => leaveRoom();

    leaveBtn.addEventListener('click', leaveRoom);
    window.addEventListener('beforeunload', leaveRoom);
  </script>
</body>
</html>
